<tal:block xmlns:i18n="http://xml.zope.org/namespaces/i18n"
           i18n:domain="silvaforum">
  <div class="forum"
       tal:define="topics context/topics;
                   here_url context/absolute_url;
                   numitems python:len(topics);
                   batch_size context/topic_batch_size;
                   batch python:context.service_views.Silva.getBatch(topics, size=batch_size, orphan=0);
                   ">
    <script type="text/javascript">
      // <![CDATA[
      function add_smiley(text_to_add) {
      /* add a smiley to the topic field
      */
      // XXX this is a bit scary... the DOM specs say text nodes can
      // be split up, but afaik that never happens in browsers... if,
      // however, people start reporting missing last bits of text, please
      // fix this code... ;)
      var topic = document.getElementById('topic');
      var content = topic.value;
      var lastchar = content.charAt(content.length - 1);
      if (lastchar && lastchar != ' ' && lastchar != '\t' && lastchar != '\n'
      && lastchar != '\r') {
      content += ' ';
      };
      content += text_to_add + ' ';
      // XXX please check the argument order here! might be wrong...
      // stupid DOM :(
      topic.value = content;
      topic.focus();
      };
      // ]]>
    </script>

    <h2 tal:content="here/get_title">
      forum title
    </h2>
    <tal:usercontrols tal:replace="structure provider:usercontrols" />
    <div class="feedback"
         tal:condition="view/message">
      <span tal:content="view/message" i18n:translate="">message</span>
    </div>

    <metal:def define-macro="pagination">
      <table class="pagination"
             tal:condition="python:numitems > batch_size">
        <tbody>
          <tr>
            <td>
              <div class="float-left" style="width:8em; text-align:left"
                   tal:define="
			       previous_batch_url python:view.get_batch_prev_link(batch.start-1);
			       firstlink python:view.get_batch_first_link(batch.start-1);
			       ">
                <a href="firstbatch"
                   accesskey="f"
                   title="Go to the first result listing: alt-f"
                   i18n:attributes="title"
                   tal:condition="firstlink"
                   tal:attributes="href firstlink"
                   ><img class="control"
                   alt="First"
                   tal:define="image context/globals/leftdouble.gif"
                   tal:attributes="
                   src image/absolute_url;
                   width image/width;
                   height image/height;
                   " />&nbsp;
                </a>
                <a href="previousbatch"
                   accesskey="b"
                   title="See the previous result listing: alt-b"
                   i18n:attributes="title"
                   tal:condition="previous_batch_url"
                   tal:attributes="href previous_batch_url"
                   ><img class="control"
                   alt="Previous"
                   tal:define="image context/globals/left.gif"
                   tal:attributes="
                   src image/absolute_url;
                   width image/width;
                   height image/height;
                   " />
                <tal:block i18n:translate="">
                  <u i18n:name="B">B</u>ack
                </tal:block>
                </a>&nbsp;
              </div>
              <div class="float-right"
		   style="width:8em; text-align:right"
                   tal:define="next_batch_url python:view.get_batch_next_link(batch.start-1, numitems);
                               lastlink python:view.get_batch_last_link(batch.start-1, numitems);
                               ">&nbsp;
              <a href="nextbatch"
                 accesskey="n"
                 title="See the next result listing: alt-n"
                 i18n:attributes="title"
                 tal:condition="next_batch_url"
                 tal:attributes="href next_batch_url">
                <tal:block i18n:translate="">
                  <u i18n:name="N">N</u>ext
                </tal:block>
                <img alt="Next"
                     i18n:attributes="alt"
                     tal:define="image context/globals/right.gif"
                     tal:attributes="src image/absolute_url;
                                     width image/width;
                                     height image/height;" />
              </a>
              <a href="#" accesskey="l"
                 title="Go to the last result listing: alt-l"
                 i18n:attributes="title"
                 tal:condition="lastlink"
                 tal:attributes="href lastlink">&nbsp;
                <img class="control"
                     alt="Last"
                     i18n:attributes="alt"
                     tal:define="image context/globals/rightdouble.gif"
                     tal:attributes="src image/absolute_url;
                                     width image/width;
                                     height image/height;" />
              </a>
              </div>
              <tal:block i18n:translate="">
                Showing results <tal:block i18n:name="start" replace="batch/start" />
                to <tal:block i18n:name="end" replace="batch/end" />
                of <tal:block i18n:name="total" replace="numitems" />
              </tal:block>
            </td>
          </tr>
        </tbody>
      </table>
    </metal:def>
    <table class="forum-content-table"
           tal:condition="python: view.preview_topic or numitems">
      <thead>
        <tr tal:condition="batch">
          <th class="align-left" i18n:translate="">Topics</th>
          <th class="align-left" i18n:translate="">Post date</th>
          <th class="align-left" i18n:translate="">Author</th>
          <th class="align-right" i18n:translate="">Comments</th>
        </tr>
      </thead>
      <tbody>
        <tal:preview tal:condition="view/preview_topic">
          <tr class="preview">
            <td class="topic">
              <p tal:content="structure python:view.format_text(view.topic)" />
              <form method="post" id="previewform"
                    tal:attributes="action here_url">
                <!-- todd says 'i don't know, man' about the next bit of code,
                     and i tend to fully agree... it works though, both in js
                     and non-js situations, and looks consistent
                     (so let's not think about it too much, i suggest ;)
                -->
                <a tal:attributes="href here_url">
                  <input class="button-clear" type="button"
                         name="clear" value="Clear"
                         i18n:attributes="value"
                         tal:attributes="onclick string:document.location='${here_url}'" />
                </a>
                <input class="button-preview" type="hidden"
		               name="topic" id="preview_topic"
                       tal:attributes="value view/topic" />
                <input class="button-post;" name="post_submit"
                       type="submit" value="Post topic"
                       i18n:attributes="value" />
              </form>
            </td>
            <td class="datetime">
              <p i18n:translate="">Now</p>
            </td>
            <td class="author">
              <p i18n:translate="">Preview</p>
            </td>
            <td class="comments">
              0
            </td>
          </tr>
        </tal:preview>
        <tal:loop repeat="topic batch">
          <tal:def define="iterate repeat/topic/odd">
            <tr tal:attributes="class python:iterate and 'even' or 'odd'">
              <td class="topic">
                <p>
                  <a tal:attributes="href topic/url"
                     tal:content="structure python:view.format_text(topic['title'])">
                    subject
                  </a>
                </p>
              </td>
              <td class="datetime">
                <p tal:content="python:view.format_datetime(topic['creation_datetime'])"
                   i18n:translate="">
                  datatime
                </p>
              </td>
              <td class="poster">
                <p tal:content="topic/creator">
                  author
                </p>
              </td>
              <td class="comments">
                <p tal:content="topic/commentlen">
                  number
                </p>
              </td>
            </tr>
          </tal:def>
        </tal:loop>
      </tbody>
    </table>
    <table metal:use-macro="view/macros/pagination">
      batching nav bar
    </table>
    <tal:if condition="view/can_post">
      <form id="forum-thread-form" method="post" action="#"
            tal:attributes="action here_url">
        <h3 i18n:translate="">Post a new topic</h3>
        <h5 i18n:translate="">Subject</h5>
        <div class="feedback"
             tal:condition="view/preview_not_topic">
          <span class="warning"
                i18n:translate="">Please provide a subject for the new topic.
          </span>
        </div>
        <input class="store" type="text"
               id="topic" name="topic" size="80"
               tal:attributes="value view/topic" />
        <div class="anonymous-input"
             tal:condition="view/anonymous_posting_allowed">
          <input class="store" type="checkbox"
                 id="anonymous" name="anonymous"
                 tal:attributes="value view/anonymous" />
           <span i18n:translate="">Post anonymous.</span>
        </div>
        <div id="emoticons">
          <span class="emoticon" tal:repeat="smileydata view/get_smiley_data">
            <img onclick="add_smiley(this.title)" alt="emoticon"
                 i18n:attributes="alt"
                 tal:attributes="title smileydata/text;
                                 src smileydata/href" />
          </span>
        </div>
        <div class="submit">
          <input class="button-add-topic" name="add_topic"
                 type="submit" value="Add topic"
                 i18n:attributes="value" />
          <input class="button-preview" name="preview"
                 type="submit" value="Preview"
                 i18n:attributes="value" />
        </div>
      </form>
    </tal:if>
  </div>
</tal:block>
