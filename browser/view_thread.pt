<div tal:define="dummy view/set_content_type_and_nocache;
                 message python:view.update() or request.get('message');
                 comments context/comments;
                 start python:int(path('request/start | nothing') or 0);
                 batch python:modules['ZTUtils'].Batch(comments,
                                                       size=10,
                                                       start=start);
                 ">
                                 
    <script type="text/javascript">
    // <![CDATA[ 
        function add_smiley(text_to_add) {
            /* add a smiley to the textarea
            */
            // XXX this is a bit scary... the DOM specs say text nodes can
            // be split up, but afaik that never happens in browsers... if,
            // however, people start reporting missing last bits of text, please
            // fix this code... ;)
            var textarea = document.getElementById('text');
            var content = textarea.value;
            var lastchar = content.charAt(content.length - 1);
            if (lastchar && lastchar != ' ' && lastchar != '\t' && lastchar != '\n'
                  && lastchar != '\r') {
                content += ' ';
            };
            content += text_to_add + ' ';
            // XXX please check the argument order here! might be wrong...
            // stupid DOM :(
            textarea.value = content;
            textarea.focus();
        };
    // ]]>
    </script>
  <div class="feedback" tal:content="message" tal:condition="message">message</div>
  <table tal:define="
         previous python:batch.previous;
         next python:batch.next">
    <tr>
      <td class="pagination">
        <a tal:condition="previous"
           tal:attributes="href string:${request/URL0}?start:int=${previous/first}"
           href="previous_url">&laquo;</a>
        <a tal:condition="next"
           tal:attributes="href string:${request/URL0}?start:int=${next/first}"
           href="next_url">&raquo;</a>
      </td>
    </tr>
  </table>  
  <table class="forum-content-table"> 
    <thead class="thead">
      <tr>
        <th>Author</th>
        <th>Message</th> 
      </tr>
    </thead>
    <tbody>
      <tr class="topic">
        <td>
          <div class="author-name">
            <p tal:replace="python:context.sec_get_creator_info().fullname()" />
          </div>
        </td>
        <td>
          <p tal:replace="python:view.format_datetime(context.get_creation_datetime())" />
          <h4 tal:content="context/get_title" /> 
          <p tal:content="structure python:view.format_text(context.get_text())" />
        </td>
      </tr>
      <tr class="forum-tr" tal:repeat="comment batch">
        <td>
          <div class="author-name">
          <tal:block tal:replace="comment/creator" />
          </div>
        </td>
        <td> 
          <a class="permalink" tal:attributes="href comment/url">permalink</a>
          <p tal:replace="python:view.format_datetime(comment['creation_datetime'])" />
          <h4 tal:content="comment/title" />
          <p tal:content="structure python:view.format_text(comment['text'])" />
        </td>
      </tr>
    </tbody>
  </table>
  <tal:block tal:condition="python:request.get('preview') and (request.get('title') or request.get('text'))">
    <table class="forum-content-table">
      <tbody>
        <tr class="forum-tr">
          <th>
            preview
          </th>
        </tr>
        <tr class="forum-tr">
          <td> 
            <h4 tal:content="request/title" />
            <p tal:content="structure python:view.format_text(request['text'])" />
          </td>
        </tr>
      </tbody>
    </table>
  </tal:block>
  <div class="submit">
    <form id="forum-comment-form" method="post"
          tal:attributes="action context/absolute_url">
      <div id="post-span">
       Post a new comment 
      </div>
      <div class="subject">
        Subject
      </div>
      <div class="subject-input">
        <input type="text" name="title" size="80"
               tal:attributes="value request/title | nothing" />
      </div>
      <div id="emoticon-interface">
        <p class="side-interface-text">Body text</p>
        <p class="side-interface-text">Emoticon interface</p>
        <div id="emoticons">
          <div class="emoticon" tal:repeat="smileydata view/get_smiley_data">
            <img onclick="add_smiley(this.title)" tal:attributes="title smileydata/text; src smileydata/href" />
          </div>
        </div>
      </div>
      <div id="text-input">
        <textarea name="text" id="text" rows="15" cols="68"
                  tal:content="python:request.get('text')"></textarea>
        <div class="submit">
          <input type="submit" name="submit" value="add comment" />
          <input type="submit" name="preview" value="preview" />
        </div>
      </div>  
    </form>
    <!--
    <script type="text/javascript">
      // <![CDATA[

      function _(id) {
        return document.getElementById(id);
      };

      var alink = document.createElement('a');
      var form = _('forum-thread-form');
      alink.href = '#';
      alink.onclick = function(evt) {
        if (form.style.display == 'none') {
          form.style.display = 'block';
          this.replaceChild(document.createTextNode('hide form'), this.firstChild);
        } else {
          form.style.display = 'none';
          this.replaceChild(document.createTextNode('new topic'), this.firstChild);
        };
        if (evt.preventDefault) {
          evt.preventDefault();
        } else {
          evt.returnValue = false;
        };
        evt.cancelBubble = true;
      };
      alink.appendChild(document.createTextNode('new topic'));
      form.parentNode.insertBefore(alink, form);
      form.style.display = 'none';

      // ]]>
    </script>
    -->
    </div>
</div>
