<div class="forum"
  tal:define="
    dummy view/set_content_type_and_nocache;
    message python:view.update() or request.get('message');
    threads context/threads;
    start python:int(path('request/start | nothing') or 0);
    batch python:modules['ZTUtils'].Batch(threads, size=10, start=start);
">
<script type="text/javascript">
// <![CDATA[
function add_smiley(text_to_add) {
    /* add a smiley to the textarea
    */
    // XXX this is a bit scary... the DOM specs say text nodes can
    // be split up, but afaik that never happens in browsers... if,
    // however, people start reporting missing last bits of text, please
    // fix this code... ;)
    var textarea = document.getElementById('text');
    var content = textarea.value;
    var lastchar = content.charAt(content.length - 1);
    if (lastchar && lastchar != ' ' && lastchar != '\t' && lastchar != '\n'
          && lastchar != '\r') {
        content += ' ';
    };
    content += text_to_add + ' ';
    // XXX please check the argument order here! might be wrong...
    // stupid DOM :(
    textarea.value = content;
    textarea.focus();
};

// ]]>
</script>
<h2 tal:content="here/get_title">
  forum title
</h2>
<div class="feedback"
  tal:condition="message"
  tal:content="message">
  message
</div>
<table class="previousnext" 
  tal:define="
    previous python:batch.previous;
    next python:batch.next"
  tal:condition="python:previous or next">
  <tr>
    <td class="pagination">
      <a tal:condition="previous"
        tal:attributes="href string:${request/URL0}?start:int=${previous/first}"
        href="previous_url">&laquo;</a>
      <a tal:condition="next"
        tal:attributes="href string:${request/URL0}?start:int=${next/first}"
        href="next_url">&raquo;</a>
    </td>
  </tr>
</table>
<table class="forum-content-table">
  <thead class="thead">
    <tr>
      <th class="align-left">Topics</th>
      <th class="align-left">Post date</th>
      <th class="align-left">Author</th>
      <th class="align-right">Comments</th>
    </tr>
  </thead>
  <tbody>
    <tal:block tal:condition="python:request.get('preview') and request.get('topic')">
      <tr class="preview">
        <td class="topic">
          <p tal:content="request/topic">
            topic
          </p>
        </td>
        <td class="datetime">
          <p>Now</p>
        </td>
        <td class="author">
          <p>Preview</p>
        </td>
        <td class="comments">
          <p>0</p>
        </td>
      </tr>
    </tal:block>
    <tr class="posting"
      tal:repeat="thread batch">
      <td class="topic">
        <p>
          <a tal:attributes="href thread/url"
            tal:content="thread/title">
            subject
          </a>
        </p>
      </td>
      <td class="comment">
        <p class="datetime" 
          tal:content="python:view.format_datetime(thread['creation_datetime'])">
          datatime
        </p>
      </td>
      <td class="poster">
        <p tal:content="thread/creator">
          author
        </p>
      </td>
      <td class="comments">
        <p tal:content="thread/commentlen">
          number
        </p>
    </tr>
  </tbody>
</table>
<div class="submit">
  <form id="forum-thread-form"
    method="post"
    tal:attributes="action context/absolute_url">
    <h3>Post a new topic</h3>
    <h5>Subject</h5>
    <div class="feedback"
      tal:condition="python:request.get('preview') and request.get('text') and not
                     request.get('topic')">
      <span class="warning">Please provide a subject.</span>
    </div>
    <div class="subject-input">
      <input class="store"
        type="text"
        name="topic"
        size="80"
        tal:attributes="value request/topic | nothing"
      />
    </div>
    <h5>Messsage</h5>
    <div id="text-input">
      <textarea class="store"
        name="text"
        id="text"
        rows="15"
        cols="68"
        tal:content="python:request.get('text')"></textarea>
      <div id="emoticons">
        <div class="emoticon" tal:repeat="smileydata view/get_smiley_data">
          <img onclick="add_smiley(this.title)"
            alt="emoticon"
            tal:attributes="title smileydata/text; src smileydata/href"
          />
        </div>
      </div>
      <div class="submit">
        <input style="float:right"
          type="submit"
          value="add thread"
        />
        <input type="submit"
          name="preview"
          value="preview"
        />
      </div>
    </div>
  </form>
  <!--
  <script type="text/javascript">
    // <![CDATA[

    function _(id) {
      return document.getElementById(id);
    };

    var alink = document.createElement('a');
    var form = _('forum-thread-form');
    alink.href = '#';
    alink.onclick = function(evt) {
      if (form.style.display == 'none') {
        form.style.display = 'block';
        this.replaceChild(document.createTextNode('hide form'), this.firstChild);
      } else {
        form.style.display = 'none';
        this.replaceChild(document.createTextNode('new topic'), this.firstChild);
      };
      if (evt.preventDefault) {
        evt.preventDefault();
      } else {
        evt.returnValue = false;
      };
      evt.cancelBubble = true;
    };
    alink.appendChild(document.createTextNode('new topic'));
    form.parentNode.insertBefore(alink, form);
    form.style.display = 'none';

    // ]]>
  </script>
  -->
  </div>
</div>
