<div class="forum"
  tal:define="
    dummy view/set_content_type_and_nocache;
    message python:view.update() or request.get('message');
    topics context/topics;
    batch python:context.service_views.Silva.getBatch(topics, size=10, orphan=0);
">
<script type="text/javascript">
// <![CDATA[

var SUPPORTED_BROWSER = false;

function getXHR() {
    try{
        return new XMLHttpRequest();
    } catch(e) {
        // not a Mozilla or Konqueror based browser
    };
    try {
        // XXX not sure if it's really better, but perhaps we should use
        // the more verbose way (with version numbers and all) for A-X
        // instantiation?
        return new ActiveXObject('Microsoft.XMLHTTP');
    } catch(e) {
        // not IE either...
    };
    return undefined;
};

function add_form(placeholder, reqvalues) {
    var url = placeholder.getAttribute('href') + '/topic_form.html';
    var xhr = getXHR();
    var add_form_handler = function() {
        if (xhr.readyState < 4) {
            return;
        };
        if (xhr.status == 200) {
            // XXX hack hack hack... but it's JS anyway :|
            var formhtml = xhr.responseText.substring(
                xhr.responseText.indexOf('form') - 1,
                xhr.responseText.lastIndexOf('/form') + 6);
            placeholder.innerHTML = formhtml;
        } else if (xhr.status == 401) {
            alert('Please log in.');
        } else {
            alert('Unknown error ' + status);
        };
    };
    var body = '';
    if (reqvalues) {
        var postpairs = [];
        for (var attr in reqvalues) {
            postpairs.push(escape(attr) + '=' + escape(reqvalues[attr]));
        };
        var body = postpairs.join('&');
        xhr.open('POST', url, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
    } else {
        xhr.open('GET', url, true);
    };
    xhr.onreadystatechange = add_form_handler;
    xhr.send(body);
};

function del_form(placeholder) {
    while (placeholder.hasChildNodes()) {
        placeholder.removeChild(placeholder.lastChild);
    };
    placeholder.appendChild(document.createTextNode('\xa0'));
};

function toggle_form(evt) {
    if (!SUPPORTED_BROWSER) {
        return true;
    };
    var placeholder = document.getElementById('form-placeholder');
    if (placeholder.getElementsByTagName('form').length) {
        del_form(placeholder);
    } else {
        add_form(placeholder);
    };
    if (evt.stopPropagation) {
        evt.stopPropagation();
    } else {
        evt.returnValue = false;
    };
    evt.cancelBubble = true;
    return false;
};

function add_smiley(text_to_add) {
    /* add a smiley to the topic field
    */
    // XXX this is a bit scary... the DOM specs say text nodes can
    // be split up, but afaik that never happens in browsers... if,
    // however, people start reporting missing last bits of text, please
    // fix this code... ;)
    var topic = document.getElementById('topic');
    var content = topic.value;
    var lastchar = content.charAt(content.length - 1);
    if (lastchar && lastchar != ' ' && lastchar != '\t' && lastchar != '\n'
          && lastchar != '\r') {
        content += ' ';
    };
    content += text_to_add + ' ';
    // XXX please check the argument order here! might be wrong...
    // stupid DOM :(
    topic.value = content;
    topic.focus();
};

function handle_preview_form_load() {
    var previewform = document.getElementById('previewform');
    if (!previewform) {
        return;
    };
    add_form(document.getElementById('form-placeholder'),
             {'topic': document.getElementById('preview_topic').value});
};

if (window.addEventListener) {
    window.addEventListener('load', handle_preview_form_load, true);
    SUPPORTED_BROWSER = true;
} else if (window.attachEvent) {
    window.attachEvent('onload', handle_preview_form_load);
    SUPPORTED_BROWSER = true;
} else {
    // very backward browser... don't do anything for now, rely on non-JS
    // fallback behaviour
};

// ]]>
</script>
<h2 tal:content="here/get_title">
  forum title
</h2>
<div class="feedback"
  tal:condition="message"
  tal:content="message">
  message
</div>
<table class="pagination"
  cellspacing="0"
  tal:condition="python:len(topics) > 10">
  <tr>
    <td class="previous">
      <tal:block condition="request/previous_batch_url | nothing">
        <a href="previousbatch"
           accesskey="f"
           title="Go to the first result listing: alt-f"
           tal:attributes="href request/previous_batch_url"
           ><img class="control"
             alt="First"
             tal:define="image context/globals/leftdouble.gif"
             tal:attributes="
               src image/absolute_url;
               width image/width;
               height image/height;
            " />&nbsp;
        </a>
      </tal:block>
      <tal:block condition="request/previous_batch_url | nothing">
        <a href="previousbatch"
          accesskey="b"
          title="See the previous result listing: alt-b"
          tal:attributes="href request/previous_batch_url" 
          ><img alt="control"
            tal:define="image context/globals/left.gif"
            tal:attributes="
              src image/absolute_url;
              width image/width;
              height image/height;
          " />
        <u>B</u>ack
        </a>
      </tal:block>
    </td>  
    <td class="info">
      Showing results
      <tal:block replace="batch/start" />
      to
      <tal:block replace="batch/end" />
      of
      <tal:block replace="python:len(topics)" />
    </td>  
    <td class="next">
      <tal:block condition="request/next_batch_url | nothing">
        <a href="nextbatch" accesskey="n"
          title="See the next result listing: alt-n"
          tal:attributes="href request/next_batch_url">
          <u>N</u>ext
          <img alt="Next"
            tal:define="image context/globals/right.gif"
            tal:attributes="
              src image/absolute_url;
              width image/width;
              height image/height;
          " />
        </a>
      </tal:block>  
      <tal:block condition="request/next_batch_url | nothing">
        <a href="nextbatch"
           accesskey="n"
           title="Go to the last result listing: alt-l"
           tal:attributes="href request/next_batch_url">&nbsp;<img
             class="control"
             alt="Last"
             tal:define="image context/globals/rightdouble.gif"
             tal:attributes="
               src image/absolute_url;
               width image/width;
               height image/height;
            " />
        </a>
      </tal:block>
    </td>
  </tr>
</table>
<table class="forum-content-table">
  <thead class="thead">
    <tr>
      <th class="align-left">Topics</th>
      <th class="align-left">Post date</th>
      <th class="align-left">Author</th>
      <th class="align-right">Comments</th>
    </tr>
  </thead>
  <tbody>
    <tal:loop repeat="topic batch">
      <tal:def define="iterate repeat/topic/odd">
        <tr tal:attributes="class python: iterate and 'even' or 'odd'">
          <td class="topic">
            <p>
              <a tal:attributes="href topic/url"
                tal:content="structure python:view.format_text(topic['title'])">
                subject
              </a>
            </p>
          </td>
          <td class="datetime">
            <p tal:content="python:view.format_datetime(topic['creation_datetime'])">
              datatime
            </p>
          </td>
          <td class="poster">
            <p tal:content="topic/creator">
              author
            </p>
          </td>
          <td class="comments">
            <p tal:content="topic/commentlen">
              number
            </p>
          </td>
        </tr>
      </tal:def>
    </tal:loop>
    <tal:preview condition="python:request.get('preview') and request.get('topic')">
      <tr class="preview">
        <td class="topic">
          <p id="previewformbox">
            <form method="post" id="previewform" tal:condition="request/form/preview | nothing"
                  tal:attributes="action context/absolute_url">
              <input type="hidden" name="topic" id="preview_topic" tal:attributes="value request/topic" />
              <input type="submit" value="add topic" />
              <!-- todd says 'i don't know, man' about the next bit of code, and i tend to
                   fully agree... it works though, both in js and non-js situations, and looks consistent
                   (so let's not think about it too much, i suggest ;)
              -->
              <a tal:attributes="href context/absolute_url">
                <input type="button" value="reset" tal:attributes="onclick string:document.location='${context/absolute_url}'" />
              </a>
            </form>
          </p>
          <p>
            <a href="." tal:content="request/topic">topic</a>
          </p>
        </td>
        <td class="datetime">
          <p>Now</p>
        </td>
        <td class="author">
          <p>Preview</p>
        </td>
        <td class="comment">
          0
        </td>
      </tr>
    </tal:preview>
  </tbody>
</table>
<a tal:attributes="href string:${context/absolute_url}/topic_form.html" onclick="return toggle_form(event);">post a topic</a>
<div id="form-placeholder" tal:attributes="href context/absolute_url">&#xa0;</div>
</div>
