<div class="forum"
  tal:define="
    dummy view/set_content_type_and_nocache;
    message python:view.update() or request.get('message');
    threads context/threads;
    batch python:context.service_views.Silva.getBatch(threads, size=10, orphan=0);
">
<script type="text/javascript">
// <![CDATA[
function add_smiley(text_to_add) {
    /* add a smiley to the textarea
    */
    // XXX this is a bit scary... the DOM specs say text nodes can
    // be split up, but afaik that never happens in browsers... if,
    // however, people start reporting missing last bits of text, please
    // fix this code... ;)
    var textarea = document.getElementById('text');
    var content = textarea.value;
    var lastchar = content.charAt(content.length - 1);
    if (lastchar && lastchar != ' ' && lastchar != '\t' && lastchar != '\n'
          && lastchar != '\r') {
        content += ' ';
    };
    content += text_to_add + ' ';
    // XXX please check the argument order here! might be wrong...
    // stupid DOM :(
    textarea.value = content;
    textarea.focus();
};

// ]]>
</script>
<h2 tal:content="here/get_title">
  forum title
</h2>
<div class="feedback"
  tal:condition="message"
  tal:content="message">
  message
</div>
<table class="previousnext">
  <tr>
    <td class="previous">
      <tal:block condition="request/previous_batch_url | nothing">
        <a href="previousbatch" accesskey="p"
           title="See the previous result listing: alt-p"
           tal:attributes="href request/previous_batch_url">
        <img alt="Previous"
             tal:define="image context/globals/left.gif"
             tal:attributes="
               src image/absolute_url;
               width image/width;
               height image/height;
        " />
        Previous</a>
      </tal:block>
    </td>
    <td class="info">
      Showing results
      <tal:block replace="batch/start" />
      to
      <tal:block replace="batch/end" />
      of
      <tal:block replace="python:len(threads)" />
    </td>
    <td class="next">
      <tal:block condition="request/next_batch_url | nothing">
        <a href="nextbatch" accesskey="n"
           title="See the next result listing: alt-n"
           tal:attributes="href request/next_batch_url">
           Next
          <img alt="Next"
               tal:define="image context/globals/right.gif"
               tal:attributes="
                 src image/absolute_url;
                 width image/width;
                 height image/height;
          "/>
        </a>
      </tal:block>
    </td>
  </tr>
</table>
<table class="forum-content-table">
  <thead class="thead">
    <tr>
      <th class="align-left">Topics</th>
      <th class="align-left">Post date</th>
      <th class="align-left">Author</th>
      <th class="align-right">Comments</th>
    </tr>
  </thead>
  <tbody>
    <tal:preview condition="python:request.get('preview') and request.get('topic')">
      <tr class="preview">
        <td class="topic">
          <p>
            <a href="." tal:content="request/topic">topic</a>
          </p>
        </td>
        <td class="datetime">
          <p>Now</p>
        </td>
        <td class="author">
          <p>Preview</p>
        </td>
        <td class="comments">
          <p>0</p>
        </td>
      </tr>
    </tal:preview>
    <tal:loop repeat="thread batch">
      <tal:def define="iterate repeat/thread/odd">
        <tr tal:attributes="class python: iterate and 'even' or 'odd'">
          <td class="topic">
            <p>
              <a tal:attributes="href thread/url"
                tal:content="thread/title">
                subject
              </a>
            </p>
          </td>
          <td class="datetime">
            <p tal:content="python:view.format_datetime(thread['creation_datetime'])">
              datatime
            </p>
          </td>
          <td class="poster">
            <p tal:content="thread/creator">
              author
            </p>
          </td>
          <td class="comments">
            <p tal:content="thread/commentlen">
              number
            </p>
          </td>
        </tr>
      </tal:def>
    </tal:loop>
  </tbody>
</table>
<form id="forum-thread-form"
  method="post"
  tal:attributes="action context/absolute_url">
  <h3>Post a new topic</h3>
  <h5>Subject</h5>
  <div class="feedback"
    tal:condition="python:request.get('preview') and request.get('text') and
                   not request.get('topic')">
    <span class="warning">Please provide a subject for the new topic.</span>
  </div>
  <div class="subject-input">
    <input class="store"
      type="text"
      name="topic"
      size="80"
      tal:attributes="value request/topic | nothing"
    />
  </div>
  <h5>Messsage</h5>
  <textarea class="store"
    name="text"
    id="text"
    rows="10"
    cols="68"
    tal:content="python:request.get('text')"></textarea>
  <div id="emoticons">
    <div class="emoticon" tal:repeat="smileydata view/get_smiley_data">
      <img onclick="add_smiley(this.title)"
        alt="emoticon"
        tal:attributes="title smileydata/text; src smileydata/href"
      />
    </div>
  </div>
  <div class="submit">
    <input style="float:right"
      type="submit"
      value="add thread"
    />
    <input type="submit"
      name="preview"
      value="preview"
    />
  </div>
</form>
<!--
<script type="text/javascript">
  // <![CDATA[

  function _(id) {
    return document.getElementById(id);
  };

  var alink = document.createElement('a');
  var form = _('forum-thread-form');
  alink.href = '#';
  alink.onclick = function(evt) {
    if (form.style.display == 'none') {
      form.style.display = 'block';
      this.replaceChild(document.createTextNode('hide form'), this.firstChild);
    } else {
      form.style.display = 'none';
      this.replaceChild(document.createTextNode('new topic'), this.firstChild);
    };
    if (evt.preventDefault) {
      evt.preventDefault();
    } else {
      evt.returnValue = false;
    };
    evt.cancelBubble = true;
  };
  alink.appendChild(document.createTextNode('new topic'));
  form.parentNode.insertBefore(alink, form);
  form.style.display = 'none';

  // ]]>
</script>
-->
</div>
